<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³¼ç‰©è»Š | Eric Justin Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f5f5f7; color: #1d1d1f; }
        .glass-nav { background: rgba(255,255,255,0.8); backdrop-filter: blur(20px); border-bottom: 0.5px solid #d2d2d7; }
        .cart-item { background: #fff; border-radius: 18px; transition: transform 0.2s; }
        .cart-item:hover { transform: scale(1.01); }
        .rounded-apple { border-radius: 20px; }
        .img-container { width: 80px; height: 80px; background: #f9f9fb; border-radius: 12px; overflow: hidden; flex-shrink: 0; }
        .input-apple { width: 100%; padding: 14px; background: #fff; border: 1px solid #d2d2d7; border-radius: 12px; font-size: 15px; outline-color: #0071e3; transition: all 0.2s; }
        .input-apple:focus { border-color: #0071e3; box-shadow: 0 0 0 4px rgba(0,113,227,0.1); }
        .btn-primary { background: #0071e3; color: white; transition: all 0.3s; }
        .btn-primary:hover:not(:disabled) { background: #0077ed; transform: translateY(-1px); }
        .btn-primary:disabled { background: #d2d2d7; cursor: not-allowed; }
    </style>
</head>
<body class="pb-20">

    <nav class="glass-nav fixed top-0 w-full z-50 h-[52px] flex items-center px-6">
        <div class="max-w-screen-xl mx-auto w-full flex justify-between items-center">
            <a href="index.html" class="font-bold text-sm tracking-tight text-black">Eric Justin</a>
            <a href="catalog.html" class="text-xs text-blue-600 hover:underline font-medium">ç¹¼çºŒé¸è³¼</a>
        </div>
    </nav>

    <main class="max-w-3xl mx-auto pt-24 px-6">
        <h1 class="text-3xl md:text-4xl font-bold mb-8 tracking-tight text-gray-900">å›é¡§æ‚¨çš„è³¼ç‰©è¢‹ã€‚</h1>

        <div id="login-alert" class="hidden mb-8 p-5 bg-blue-50 border border-blue-100 rounded-apple flex justify-between items-center shadow-sm">
            <div>
                <p class="text-sm font-bold text-blue-900">ä½¿ç”¨ Google å¸³è™Ÿçµå¸³</p>
                <p class="text-xs text-blue-700">ç™»å…¥å¾Œå³å¯äº«æœ‰è¨‚å–®è¿½è¹¤èˆ‡å®‰å…¨é˜²è­·</p>
            </div>
            <button onclick="handleQuickLogin()" class="bg-blue-600 text-white px-4 py-2 rounded-full text-xs font-bold hover:bg-blue-700">å¿«é€Ÿç™»å…¥</button>
        </div>

        <div id="cart-list" class="space-y-4">
            <div class="py-20 text-center text-gray-400">æ­£åœ¨åŒæ­¥é›²ç«¯åƒ¹æ ¼...</div>
        </div>

        <div id="shipping-section" class="mt-12 space-y-6 hidden">
            <h2 class="text-2xl font-bold tracking-tight">å¯„é€è©³æƒ…ã€‚</h2>
            <div class="bg-white p-6 rounded-apple shadow-sm space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-2 uppercase ml-1">æ”¶ä»¶äººå§“å (é™ 20 å­—)</label>
                    <input type="text" id="cust-name" maxlength="20" placeholder="è«‹è¼¸å…¥æ”¶ä»¶äººçœŸå¯¦å§“å" class="input-apple">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-2 uppercase ml-1">è¯çµ¡é›»è©± (é™ 15 å­—)</label>
                    <input type="tel" id="cust-phone" maxlength="15" placeholder="ä¾‹å¦‚ï¼š0912345678" class="input-apple">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-2 uppercase ml-1">å®Œæ•´æ”¶ä»¶åœ°å€ (é™ 100 å­—)</label>
                    <textarea id="cust-address" rows="3" maxlength="100" placeholder="è«‹è¼¸å…¥åŒ…å«éƒµéå€è™Ÿçš„å®Œæ•´åœ°å€" class="input-apple"></textarea>
                </div>
            </div>
        </div>

        <div id="checkout-section" class="mt-12 space-y-4 hidden border-t border-gray-200 pt-8">
            <div class="flex justify-between text-gray-500 text-sm">
                <span>å°è¨ˆ (ä»¥é›²ç«¯å®šåƒ¹ç‚ºæº–)</span>
                <span id="subtotal">NT$ 0</span>
            </div>
            <div class="flex justify-between text-gray-500 text-sm">
                <span>é‹è²»</span>
                <span class="text-green-600 font-medium">å…é‹è²»</span>
            </div>
            <div class="flex justify-between text-2xl font-bold mt-4">
                <span>ç¸½è¨ˆ</span>
                <span id="grand-total" class="text-black">NT$ 0</span>
            </div>

            <button onclick="processOrder()" id="checkout-btn" class="w-full btn-primary py-4 rounded-apple font-bold text-lg mt-8 shadow-xl shadow-blue-500/20">
                ç¢ºèªçµå¸³
            </button>
        </div>

        <div id="empty-cart" class="hidden py-32 text-center">
            <div class="text-6xl mb-6">ğŸ›’</div>
            <p class="text-gray-400 text-lg mb-8">æ‚¨çš„è³¼ç‰©è¢‹æ˜¯ç©ºçš„ã€‚</p>
            <a href="catalog.html" class="inline-block bg-black text-white px-10 py-3 rounded-full font-bold shadow-lg">å»é¸è³¼ä½œå“</a>
        </div>
    </main>

    <script>
        const _supabase = supabase.createClient('https://oikubhlwdbxrfhifqusn.supabase.co', 'sb_publishable_jwPs6RwbH4W4qg1ttjjZog_BcTN8VJy');
        
        let myCart = [];
        let realProducts = []; 

        async function initCart() {
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) {
                document.getElementById('login-alert').classList.remove('hidden');
            } else {
                if(!document.getElementById('cust-name').value) {
                    document.getElementById('cust-name').value = session.user.user_metadata.full_name || '';
                }
            }
            const { data: products, error } = await _supabase.from('products').select('*');
            if (error) return;
            realProducts = products;
            const savedCart = localStorage.getItem('ej_cart');
            if (savedCart && JSON.parse(savedCart).length > 0) {
                myCart = JSON.parse(savedCart);
                myCart = myCart.map(item => {
                    const realItem = realProducts.find(p => p.id === item.id);
                    // åŒæ­¥é›²ç«¯æœ€æ–°çš„åç¨±èˆ‡åƒ¹æ ¼ï¼ŒåŒæ™‚ä¿ç•™æœ¬åœ°æš«å­˜çš„åœ–ç‰‡è·¯å¾‘ä½œç‚ºå¾Œå‚™
                    return realItem ? { ...item, price: realItem.price, name: realItem.name, image: realItem.image_url || item.image } : item;
                });
                renderCart();
            } else { showEmpty(); }
        }

        async function handleQuickLogin() {
            const { error } = await _supabase.auth.signInWithOAuth({
                provider: 'google',
                options: { redirectTo: window.location.href }
            });
        }

        function renderCart() {
            const list = document.getElementById('cart-list');
            list.innerHTML = '';
            let total = 0;
            if (myCart.length === 0) { showEmpty(); return; }
            myCart.forEach((item, index) => {
                total += item.price * item.qty;
                list.innerHTML += `
                    <div class="cart-item p-5 flex gap-5 items-center shadow-sm">
                        <div class="img-container"><img src="${item.image || 'photo/S__38223874.jpg'}" class="w-full h-full object-cover"></div>
                        <div class="flex-grow">
                            <h3 class="font-bold text-base leading-tight">${item.name}</h3>
                            <div class="flex items-center gap-4 mt-3">
                                <span class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-500 font-bold">æ•¸é‡: ${item.qty}</span>
                                <button onclick="removeItem(${index})" class="text-xs text-red-500 font-medium hover:underline">ç§»é™¤</button>
                            </div>
                        </div>
                        <div class="text-right"><p class="font-bold text-gray-900">NT$ ${(item.price * item.qty).toLocaleString()}</p></div>
                    </div>`;
            });
            document.getElementById('subtotal').innerText = `NT$ ${total.toLocaleString()}`;
            document.getElementById('grand-total').innerText = `NT$ ${total.toLocaleString()}`;
            document.getElementById('checkout-section').classList.remove('hidden');
            document.getElementById('shipping-section').classList.remove('hidden');
            document.getElementById('empty-cart').classList.add('hidden');
        }

        function removeItem(index) {
            myCart.splice(index, 1);
            localStorage.setItem('ej_cart', JSON.stringify(myCart));
            renderCart();
        }

        function showEmpty() {
            document.getElementById('checkout-section').classList.add('hidden');
            document.getElementById('shipping-section').classList.add('hidden');
            document.getElementById('empty-cart').classList.remove('hidden');
        }

        async function processOrder() {
            const name = document.getElementById('cust-name').value.trim().substring(0, 20);
            const phone = document.getElementById('cust-phone').value.trim().substring(0, 15);
            const address = document.getElementById('cust-address').value.trim().substring(0, 100);

            if (!name || !phone || !address) { alert("è«‹å¡«å¯«å®Œæ•´æ”¶ä»¶è©³æƒ…"); return; }

            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) { alert("è«‹å…ˆç™»å…¥"); return; }

            const btn = document.getElementById('checkout-btn');
            btn.disabled = true;
            btn.innerText = "é©—è­‰ä¸¦å»ºç«‹è¨‚å–®...";

            let finalTotal = 0;
            // ã€æ ¸å¿ƒä¿®æ­£é»ã€‘ç¢ºä¿å°‡ image è·¯å¾‘å­˜å…¥ finalItems é™£åˆ—
            const finalItems = myCart.map(item => {
                const real = realProducts.find(p => p.id === item.id);
                const price = real ? real.price : 0;
                // å„ªå…ˆä½¿ç”¨é›²ç«¯è³‡æ–™åº«çš„åœ–ç‰‡æ¬„ä½ (image_url)
                const img = real?.image_url || item.image || 'photo/S__38223874.jpg';
                
                finalTotal += price * item.qty;
                return { 
                    id: item.id, 
                    name: item.name, 
                    price: price, 
                    qty: item.qty,
                    image: img // å­˜å…¥é€™è¡Œå¾Œï¼Œorders.html æ‰èƒ½è®€åˆ°æ­£ç¢ºåœ–ç‰‡
                };
            });

            const orderData = {
                user_email: session.user.email,
                user_name: name,
                user_phone: phone,
                shipping_address: address,
                items: finalItems,
                total_amount: finalTotal,
                status: 'pending'
            };

            try {
                const { data: newOrder, error: dbError } = await _supabase
                    .from('orders')
                    .insert([orderData])
                    .select()
                    .single();

                if (dbError) throw dbError;

                btn.innerText = "ç™¼é€é›²ç«¯ç¨½æ ¸é€šçŸ¥...";
                
                await _supabase.functions.invoke('notify-discord', {
                    body: { order_id: newOrder.id }
                });
                
                localStorage.removeItem('ej_cart');
                alert("ğŸ‰ è¨‚å–®æˆåŠŸï¼");
                location.href = "orders.html";
            } catch (err) {
                alert("å¤±æ•—ï¼š" + err.message);
                btn.disabled = false;
                btn.innerText = "ç¢ºèªçµå¸³";
            }
        }
        initCart();
    </script>
</body>
</html>